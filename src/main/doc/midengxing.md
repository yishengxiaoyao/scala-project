# 幂等性
幂等函数，或幂等方法，是指可以使用相同参数重复执行，并能获得相同结果的函数。
即:就是针对一个操作，不管做多少次，产生效果或返回的结果都是一样的。

## 实现幂等性的方案
### 查询操作
查询一次和查询多次，在数据不变的情况下，查询结果是一样的，select是天然的幂等操作。
### 删除操作
查询一次和查询多次，在数据不变的情况下，查询结果是一样的，select是天然的幂等操作。
### 前端js提交禁止按钮可以用一些js组件
在用户点击按钮之后,使用js代码将按钮置灰,在数据返回之前,按钮不可用。
### 使用Post/Redirect/Get模式
在提交后执行页面重定向，这就是所谓的Post-Redirect-Get (PRG)模式。简言之，当用户提交了表单后，你去执行一个客户端的重定向，
转到提交成功信息页面。这能避免用户按F5导致的重复提交，而其也不会出现浏览器表单重复提交的警告，
也能消除按浏览器前进和后退按导致的同样问题。

### 在session中存放一个特殊标志
在服务器端，生成一个唯一的标识符，将它存入session，同时将它写入表单的隐藏字段中，然后将表单页面发给浏览器，用户录入信息后点击提交，
在服务器端，获取表单中隐藏字段的值，与session中的唯一标识符比较，相等说明是首次提交，就处理本次请求，
然后将session中的唯一标识符移除；不相等说明是重复提交，就不再处理。
### 借助数据库
insert使用唯一索引 update使用 乐观锁 version版本法

这种在大数据量和高并发下效率依赖数据库硬件能力,可针对非核心业务

### 借助悲观锁
使用select … for update ,这种和 synchronized 锁住先查再insert or update一样,但要避免死锁,效率也较差

针对单体 请求并发不大 可以推荐使用 

### 借助分布式redis锁
借助redis缓存token,使用拦截器来拦截用户请求,校验用户的token是否可用,如果可用，就执行请求,如果不可用,就放弃请求。

实际操作参考:https://mp.weixin.qq.com/s/v_iyZVd5ldixnhaxkdSArA

## 每秒上万并发下的Spring Cloud参数优化实战

### 优化服务性能
对数据库进行简单操作,复杂的逻辑放在业务逻辑中执行。

### 设置hystrix和ribbon时间
设置hystrix和ribbon的时间的时候,最好设置为1s之内。
### 重试次数
合理设置重试次数。设置重试之后,就需要做幂等性操作:
>* 在数据库中设置唯一索引,如果再次插入，就会报错。
>* 通过redis保证一个唯一值,在插入数据的时候，进行判断，如果存在，就不能插入。



## 参考文献
[每秒上万并发下的Spring Cloud参数优化实战](https://mp.weixin.qq.com/s/nVfcL0G9rd5qjYgvp-9MzA)
[8 种方案解决重复提交问题！你选择哪一种呀？](https://mp.weixin.qq.com/s/LxqbJLMxazFetn-q-v-N5w)
[聊聊高并发下的接口幂等性](https://mp.weixin.qq.com/s/Hvra3o5J48WHSa1Bg35wgw)
[Spring Boot + Redis 实现接口幂等性 | 分布式开发必知！](https://mp.weixin.qq.com/s/v_iyZVd5ldixnhaxkdSArA)