# 分布式相关
## 分布式产生的原因
>* 增大系统容量:随着业务的扩大，一台机器的性能无法满足需求，需要多台机器应对大规模的应用场景。
>* 加强系统可用:系统不能因为一台机器出现故障而导致整体不可用，需要消除单点故障。

## 单体架构 vs 分布式架构
| |传统单体架构|分布式服务化架构|
|----|----|----|
|新功能开发|需要时间|需要开发和实现|
|部署|不经常且容易部署|经常开发，部署复杂|
|隔离性|故障影响范围大|故障影响范围小|
|架构设计|难度小|难度系数增加(分布式事物)|
|系统性能|响应时间快，吞吐量小|响应时间慢，吞吐量大|
|系统运维|运维简单|运维复杂|
|新人上手|学习曲线大|学习曲线大|
|技术|技术单一且封闭|技术多样且开放|
|测试和差错|简单|复杂|
|系统扩展性|扩展性很差|扩展性很好|
|系统管理|重点在开发开发|重点在于服务治理和调度|

## 分布式系统中需要注意的问题
### 异构系统的不标准问题
每个系统会根据需求的不同，会有不同的开发语言、数据格式、通讯协议，开发和运维的方式也会有不同。

### 系统架构中的服务依赖性问题
服务之间是相互依赖，如果一个服务发生故障，就会影响其他服务。

### 故障发生的概率更大
机器和服务数量越来越多时，人类无法做到事无巨细。

### 多层的架构运维复杂度更大
多层架构，就会牵扯到更多的技术，运维同学不可能对所有的数据都很熟。


## 分布式系统的技术栈
构建分布式系统的目的是增加系统容量，提高系统的可用性。

### 提高架构的性能
|系统|介绍|相关软件|
|----|----|----|
|缓存系统|提高系统的访问能力:<br/>a.缓存分区(根据需求设置分区负责);<br>.缓存更新(设置更新策略);<br/>c.缓存命中(读写分离)|Redis|
|负载均衡|负载均衡是水平扩张的关键技术，<br/>将流量分配到不同的机器上，<br/>保证服务高可用性|nginx、ELB、HAProxy、LVS|
|异步调用|通过队列来对请求进行处理，<br/>增加吞吐量，减少服务压力，<br/>时效性差|Kafka、RabbitMQ|
|数据镜像|数据库做成多分一样数据||
|数据分区|将数据分成不同的区域||


### 提高系统的稳定性

|技术|介绍|
|----|----|
|服务拆分|服务隔离;重用服务模块|
|服务冗余|解决单点故障，快速伸缩，以及故障迁移|
|限流降流|流量过滤，或者屏蔽用户|
|高可用架构|多租户隔离，灾备多火，不出现单点故障|
|高可用运维|Devops中的CI/CD|


### 分布式系统的关键技术
>* 服务治理:服务之间的依赖关系、调用关系，梳理重要服务，并且对服务的可用性和性能管理。
>* 架构软件管理:服务有各种版本，服务之间有依赖关系，如何做到不出现兼容行问题。
>* Devops:环境构建、持续集成、持续部署等。
>* 自动化运维:自动化部署、自动伸缩、自动恢复、故障自动迁移等。
>* 资源调度管理:平台在节点出现问题是时，自动调度任务到其他节点上运行。
>* 整体架构监控:对应用层、中间件层、基础层进行监控。
>* 流量控制:负载均衡、服务路由、熔断、降级、限流等和流量相关的调度都会在这里。


## 分布式关键技术:全栈监控

### 多层体系的监控
>* 基础层:监控主机和底层资源。例如:CPU、内存、网络吞吐等。
>* 中间层:中间件层的监控。例如:Nginx、Redis、Kafka、MySQL等。
>* 应用层:监控应用层的使用。例如:QPS、响应时间、返回码等

### 什么才是好的监控系统

现有监控系统的问题:
>* 监控数据是隔离开来的。分工不同，各管各的，串联不起来。
>* 监控的数据项太多。记录了一些没有必要的数据项，没有重点。

监控系统的应用场景:
>* 体检
>   * 容量管理:系统自己预估需要的机器数量或者其他资源的数量。
>   * 性能管理:找出系统瓶颈，瓶颈代码，以及改进意见。
>* "急诊"
>   * 定位问题:快速找到问题的发生点。
>   * 性能分析:快速找到系统的瓶颈。

### 如何做出一个好的监控系统
一个好的监控系统应该出现的功能:
>* 服务调用链跟踪:一个请求经过哪些服务的路径，软件:zipkin、cat、skywalking。对于Java类的服务，使用字节码技术进行字节码注入，做到代码无入侵式。
>* 服务调用时长分布:一个请求在每个服务提留的时间，以及时间分布。
>* 服务的TOP N视图:系统请求的排名情况:调用量排名、请求量最耗时排名、热点排名。
>* 数据库操作关联:通过Java agent字节码注入方式拿到JDBC执行数据库操作的执行时间。
>* 服务资源跟踪:当前物理机、虚拟机、docker使用多少资源，还剩余多少资源。

## 分布式系统关键技术:服务调度

### 服务的关键程度和服务的依赖关系

服务的关键程度是对业务的理解，才能定义出架构中各个服务的重要程度。
服务之间的依赖越多，关系就越复杂。
微服务是服务依赖最优解的上限，而服务依赖的下限是千万不要有依赖环。可以通过zipkin、cat等相关软件查看服务依赖关系图。

### 服务状态和生命周期的管理
服务的生命周期通常会有一下几个状态:
>* Provision:代表在供应一个新的服务；
>* Ready:表示启动成功；
>* Run:表示通过了健康检查；
>* Update:升级中；
>* Rollback：回滚中
>* Scale:伸缩中
>* Destroy:销毁中
>* Failure:失败状态

### 整个架构的版本管理
记录每个软件所有的版本，以及每个版本运行的时常、服务器需要资源多少，现有线上运行服务的版本，以及服务需要的资源，可以做到自动化的升级、回滚。

### 资源/服务调度
自动对服务集群可以进行升级、回滚，在服务出现故障时，摘除异常节点，将流量达到其他好的节点上。

## 分布式系统关键技术:流量和数据调度

服务治理和流量调度的区别:
>* 服务治理是内部系统的事，流量调度可以是内部，更是外部接入层的事。
>* 服务治理是数据中心的事，流量调度是数据中心之外的事。

### 流量调度的主要功能
>* 在无人工干扰的情况下，根据系统运行的情况，自动地进行流量调度，提升整个系统的稳定性。
>* 可以应对突发事件，可以对底层资源进行扩容、所容，保证系统平稳运行。
>* 服务流控:服务发现、服务路由、服务降级、服务熔断、服务保护等。
>* 服务控制:负载均衡、流量分配、流量控制、异地灾备等。
>* 流量管理:协议转换、请求校验、数据缓存、数据计算等。

### 流量调度的关键技术
>* 高性能:网关必须使用高性能的技术。
>* 抗流量:在集群内的各个节点中共享数据。
>* 业务逻辑:可以注入不同语言的简单业务逻辑。
>* 服务化:动态管理配置变更。

### 状态数据调度
将数据放入到第三方的服务上，可以只需要移动服务。
数据副本是分布式系统解决数据丢失异常的唯一手段。
在应用层上解决事务问题，只有两阶段提交这样的方式，而在数据层解决事务问题，Paxos算法则是不二之选。
状态数据调度应该是由分布式存储系统来解决的。

## 洞悉Paas平台的本质
一家公司的软件工程能力主要体现在三个地方:
1.提高服务的SLA:高可用的运维;自动化的运维。
2.能力和资源重用或者复用:软件模块的重用;软件运行环境和资源的重用。
3.过程自动化:软件生产流水线;软件运维自动化。

### Paas平台的本质
Paas与传统中间件最大的差别:
>* 服务化是Paas的本质。软件模块重用，服务治理，对外提供能力是Paas的本质。
>* 分布式是Paas的根本特性。多租户隔离、高可用、服务编排是Paas的基本特性。
>* 自动化是Paas的灵魂。自动化部署安装运维，自动化伸缩调度是Paas的关键。

### Paas平台的总体架构
Paas平台包括一下几部分:
>* Paas调度层:主要是Paas的自动化和分布式对于高可用高性能的管理。
>* Paas能力服务层:主要是Paas真正提供给用户的服务和能力。
>* Paas的流量调度:主要是与流量调度相关的东西，包含对高并发的管理。
>* Paas的运营管理:软件资源库、软件接入、认证和开发平台门户。
>* Paas的运维管理:主要是DevOps相关的东西。



## 参考文献




